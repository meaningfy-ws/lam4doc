{% import "common/macros.html" as mc %}

{% macro build_concept_defining_configuration_list (concept_uri) %}
    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
prefix lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

select ?property ?propertyName
{
  values ?concept {<"~concept_uri~">}
  ?concept lam:classifyWith ?property .
    optional{
  ?property sh:name ?propertyName .
  }
} order by ?propertyName" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call mc.render_fetch_results(content, error) %}
        {% if not content.empty %}
            <dl>
                <dt>Defining configuration</dt>
                {% for idx, row in content.iterrows() %}
                    <dd>
                        <dl>
                            <dt>{{ row["propertyName"] }}</dt>
                            <dd>
                                <dl>
                                    <dt>IRI</dt>
                                    <dd><a href="#{{ row["property"] }}">{{ row["property"] }}</a></dd>
                                </dl>
                            </dd>
                            <dd>{{ build_concept_property_defining_configuration_view(row["property"]) }}</dd>
                        </dl>
                    </dd>
                {% endfor %}
            </dl>
        {% endif %}
    {% endcall %}
{% endmacro %}

{% macro build_concept_property_defining_configuration_view(property_uri) %}
    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX sh: <http://www.w3.org/ns/shacl#>
PREFIX dct: <http://purl.org/dc/terms/>
PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

select ?value ?minCount ?maxCount ?description ?note ?created
{
  values ?property {<"~property_uri~">}
  ?property a lam:MappingPropertyConfiguration .

  {?property sh:value ?value .}
  union{
  ?property sh:minCount ?minCount .
  }union{
  ?property sh:description ?description .
  }union{
  ?property skos:editorialNote ?note
  }
}" %}



    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call mc.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            {{ mc.build_description_item_plain_literal (content,"value","Value") }}
            {{ mc.build_description_item_plain_literal (content,"minCount","Min count") }}
            {{ mc.build_description_item_plain_literal (content,"description","Description") }}
            {{ mc.build_description_item_plain_literal (content,"note","Editorial note") }}
        {% endif %}
    {% endcall %}


{% endmacro %}
