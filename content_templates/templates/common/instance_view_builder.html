{% import "common/macros.html" as macros %}

{% macro build_instance_view (graph, instance_uri, instance_label, level, is_concept=false) %}
    <p class="debug">build_instance_view <strong>{{ instance_label }} level:{{ level }}</strong></p>

    <h{{ level }} id="{{ instance_uri }}">
        {{ instance_label }}
        {% if is_concept %}
             <sup title="concept">[concept]</sup>
        {% else %}
            <sup title="collection">[collection]</sup>
        {% endif %}
    </h{{ level }}>
    <section>
        <dl>
            <dt>IRI</dt>
            <dd><a href="#{{ instance_uri }}">{{ instance_uri }}</a></dd>
        </dl>
        {{ build_instance_metadata_part(graph, instance_uri) }}
        {{ build_instance_editorial_part(graph, instance_uri) }}
    </section>
{% endmacro %}

{% macro build_instance_metadata_part(graph, instance_uri) %}
    <p class="debug">build_instance_metadata_part <strong>{{ instance_uri }}</strong></p>

    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
    PREFIX dct: <http://purl.org/dc/terms/>

    select ?altLabel ?definition ?notation ?identifier
    FROM <"~graph~">
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance skos:altLabel ?altLabel
      }
      union {
        ?instance skos:definition ?definition .
      }
      union {
        ?instance skos:notation ?notation
      }
      union {
        ?instance dct:identifier ?identifier
      }
    }" %}

    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            {{ macros.render_description_item_plain_literal (content, "altLabel", "Alternative label") }}
            {{ macros.render_description_item_plain_literal (content, "definition", "Definition") }}
            {{ macros.render_description_item_plain_literal (content, "notation", "Notation") }}
            {{ macros.render_description_item_plain_literal (content, "identifier", "Identifier") }}
        {% endif %}
    {% endcall %}
{% endmacro %}

{% macro build_instance_editorial_part(graph, instance_uri) %}
    <p class="debug">build_instance_editorial_part <strong>{{ instance_uri }}</strong></p>

    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
    PREFIX dct: <http://purl.org/dc/terms/>
    PREFIX euvoc: <http://publications.europa.eu/ontology/euvoc#>

    select ?created ?order ?notation ?member ?scopeNote ?example ?editorialNote ?historyNote ?changeNote
    FROM <"~graph~">
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance dct:created ?created .
      }
      union {
        ?instance euvoc:order ?order .
      }
      union {
        ?instance skos:notation ?notation .
      }
      union {
        ?instance skos:member ?member .
      }
      union {
        ?instance skos:scopeNote ?scopeNote
      }
      union {
        ?instance skos:example ?example
      }
      union {
        ?instance skos:editorialNote ?editorialNote
      }
      union {
        ?instance skos:historyNote ?historyNote
      }
      union {
        ?instance skos:changeNote ?changeNote
      }
    }" %}

    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            {{ macros.render_description_item_plain_literal (content, "order", "Order") }}
            {{ macros.render_description_item_local_iri (content,"member","Members") }}
            {{ macros.render_description_item_plain_literal (content,"created","Created Date") }}
            {{ macros.render_description_item_plain_literal (content, "notation", "Notation") }}
            {{ macros.render_description_item_plain_literal (content, "scopeNote", "Scope note") }}
            {{ macros.render_description_item_plain_literal (content, "example", "Example") }}
            {{ macros.render_description_item_plain_literal (content, "editorialNote", "Editorial note") }}
            {{ macros.render_description_item_plain_literal (content, "historyNote", "History note") }}
            {{ macros.render_description_item_plain_literal (content, "changeNote", "Change note") }}
        {% endif %}
    {% endcall %}
{% endmacro %}