{% import "common/macros.html" as macros %}

{% macro build_instance_view (graph, instance_uri, instance_label, level, is_concept=false) %}
    <p class="debug">build_instance_view <strong>{{ instance_label }} level:{{ level }}</strong></p>

    <h{{ level }} id="{{ instance_uri }}">
        {{ instance_label }}
        {% if is_concept %}
            <sup title="concept">[concept]</sup>
        {% else %}
            <sup title="collection">[collection]</sup>
        {% endif %}
    </h{{ level }}>
    <section>
        {{ build_instance_metadata_part(graph, instance_uri) }}
        {{ build_instance_editorial_part(graph, instance_uri) }}
        {{ build_lam_property_configuration_list(graph, instance_uri, level + 1) }}
    </section>
{% endmacro %}

{% macro build_instance_metadata_part(graph, instance_uri) %}
    <p class="debug">build_instance_metadata_part <strong>{{ instance_uri }}</strong></p>

    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
    PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX dct: <http://purl.org/dc/terms/>
    PREFIX euvoc: <http://publications.europa.eu/ontology/euvoc#>
    PREFIX owl: <http://www.w3.org/2002/07/owl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    SELECT ?deprecated ?altLabel ?created ?modified ?notation ?identifier ?order ?class ?path
    FROM <"~graph~">
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance owl:deprecated ?deprecated
      }
      union {
        ?instance skos:altLabel ?altLabel
      }
      union {
        ?instance dct:created ?created .
      }
      union {
        ?instance dct:modified ?modified
      }
      union {
        ?instance skos:notation ?notation
      }
      union {
        ?instance dct:identifier ?identifier
      }
      union {
        ?instance euvoc:order ?order .
      }
      union {
        ?instance sh:class ?class .
      }
      union {
        ?instance sh:path ?path .
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            <dl>
                <dt>IRI</dt>
                <dd><a href="#{{ instance_uri }}">{{ instance_uri }}</a></dd>
            </dl>
            {{ macros.render_description_item_plain_literal (content, "deprecated", "Deprecated on") }}
            {{ macros.render_description_item_plain_literal (content, "altLabel", "Alternative label") }}
            {{ macros.render_description_item_plain_literal (content, "created", "Created on") }}
            {{ macros.render_description_item_plain_literal (content, "modified", "Modified on") }}
            {{ macros.render_description_item_plain_literal (content, "notation", "Notation") }}
            {{ macros.render_description_item_plain_literal (content, "identifier", "Identifier") }}
            {{ macros.render_description_item_plain_literal (content, "order", "Order") }}
            <p class="debug-render">skos concept part for</p>
            {{ macros.render_description_item_plain_literal (content, "class", "Class") }}
            {{ macros.render_description_item_plain_literal (content, "path", "Path") }}
        {% endif %}
    {% endcall %}
{% endmacro %}

{% macro build_instance_editorial_part(graph, instance_uri) %}
    <p class="debug">build_instance_editorial_part <strong>{{ instance_uri }}</strong></p>

    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
    PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX dct: <http://purl.org/dc/terms/>
    PREFIX euvoc: <http://publications.europa.eu/ontology/euvoc#>

    select ?definition ?scopeNote ?example ?changeNote ?historyNote ?editorialNote ?note ?member ?shName ?shDescription
    FROM <"~graph~">
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance skos:definition ?definition .
      }
      union {
        ?instance skos:scopeNote ?scopeNote
      }
      union {
        ?instance skos:example ?example
      }
      union {
        ?instance skos:changeNote ?changeNote
      }
      union {
        ?instance skos:historyNote ?historyNote
      }
      union {
        ?instance skos:editorialNote ?editorialNote
      }
      union {
        ?instance skos:note ?note
      }
      union {
        ?instance skos:member ?member .
      }
      union {
        ?instance sh:name ?shName .
      }
      union {
        ?instance sh:description ?shDescription .
      }
    }" %}

    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            <p class="debug-render">skos editorial part for <strong>{{ instance_uri }}</strong></p>
            {{ macros.render_description_item_plain_literal (content,"definition", "Definition") }}
            {{ macros.render_description_item_plain_literal (content, "scopeNote", "Scope note") }}
            {{ macros.render_description_item_plain_literal (content, "example", "Example") }}
            {{ macros.render_description_item_plain_literal (content, "changeNote", "Change note") }}
            {{ macros.render_description_item_plain_literal (content, "historyNote", "History note") }}
            {{ macros.render_description_item_plain_literal (content, "editorialNote", "Editorial note") }}
            {{ macros.render_description_item_plain_literal (content, "note", "Note") }}
            {{ macros.render_description_item_local_iri (content, "member", "Members") }}
            <p class="debug-render">sh editorial part for <strong>{{ instance_uri }}</strong></p>
            {{ macros.render_description_item_plain_literal (content, "shName", "Name") }}
            {{ macros.render_description_item_plain_literal (content, "shDescription", "Description") }}
        {% endif %}
    {% endcall %}
{% endmacro %}

{% macro build_lam_property_configuration_list(graph, instance_uri, level) %}
    <p class="debug">build_lam_property_configuration_list <strong>{{ instance_uri }}</strong></p>
    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    select ?propertyConfiguration ?name
    FROM <"~graph~">
    {
      values ?instance {<"~instance_uri~">}
      ?instance lam:hasPropertyConfiguration ?propertyConfiguration .
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% for row in content.itertuples() %}
            {{ build_lam_property_configuration(graph, row.propertyConfiguration, level) }}
        {% endfor %}
    {% endcall %}
{% endmacro %}


{% macro build_lam_property_configuration(graph, instance_uri, level) %}
    <p class="debug">build_lam_property_configuration <strong>{{ instance_label }}</strong></p>

    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    select ?name
    FROM <"~graph~">
    {
      values ?instance {<"~instance_uri~">}
      ?instance sh:name ?name .
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.empty %}
            {% for row in content.itertuples() %}
                <h{{ level }}>
                    {{ row.name }}<sup title="concept">[concept]</sup>
                </h{{ level }}>
            {% endfor %}
        {% endif %}
    {% endcall %}
    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    select ?path ?class ?value ?minCount ?maxCount ?configurations
    FROM <"~graph~">
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance lam:path ?path .
      }
      union {
        ?instance sh:class ?class
      }
      union {
        ?instance sh:hasValue ?value
      }
      union {
        ?instance sh:minCount ?minCount
      }
      union {
        ?instance lam:hasAnnotationConfiguration ?configurations
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            {{ macros.render_description_item_local_iri (content, "path", "Path") }}
            {{ macros.render_description_item_plain_literal (content, "class", "Class") }}
            {{ macros.render_description_item_plain_literal (content, "value", "Value") }}
            {{ macros.render_description_item_plain_literal (content, "minCount", "Min Count") }}
            {{ macros.render_description_item_plain_literal (content, "maxCount", "Max Count") }}
            {% set values =  content["configurations"].dropna() %}
            {% if not values.empty %}
                <p class="debug">build_lam_property_configuration for hasAnnotationConfiguration <strong>{{ instance_uri }}</strong></p>
                {% for idx, item in values.iteritems() %}
                    {{ build_lam_property_configuration(graph, item, level + 1) }}
                {% endfor %}
            {% endif %}
        {% endif %}
    {% endcall %}
{% endmacro %}