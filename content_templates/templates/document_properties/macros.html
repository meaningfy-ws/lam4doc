{% import "common/macros.html" as macros %}
{% import "common/collection_macros.html" as collection_macros %}
{% import "common/concept_macros.html" as concept_macros %}

{% macro build_document_properties_child_collections(collection_uri, level) %}
    <p class="debug-children">build_child_collections | level: {{ level }} | collection_uri: {{ collection_uri }}</p>
    {% set graph = conf.graphs.document_property %}
    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

    SELECT ?member ?prefLabel
    FROM <"~graph~">
    {
      values ?collection {<"~collection_uri~">}
      ?member a skos:Collection .
      ?collection skos:member ?member .
      optional {
        ?member skos:prefLabel ?prefLabel
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.empty %}
            <p class="debug">collection's not empty {{ collection_uri }}</p>
            {% for row in content.itertuples() %}
                <p class="debug">building {{ row.prefLabel }}</p>
                {{ collection_macros.build_collection_view(graph, row.member, row.prefLabel, level) }}
                {{ build_document_properties_child_collections(row.member, level + 1) }}
                {{ build_document_properties_child_concepts(row.member, level + 1) }}
            {% endfor %}
        {% endif %}
    {% endcall %}
{% endmacro %}


{% macro build_document_properties_child_concepts(collection_uri, level) %}
    <p class="debug-children">build_child_concepts | level: {{ level }} | collection_uri: {{ collection_uri }}</p>
    {% set graph = conf.graphs.document_property %}
    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>

    SELECT ?member ?prefLabel
    FROM <"~graph~">
    {
      values ?collection {<"~collection_uri~">}
      ?member a skos:Concept .
      ?collection skos:member ?member .
      optional {
        ?member skos:prefLabel ?prefLabel
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.empty %}
            <p class="debug">concept's not empty {{ collection_uri }}</p>
            {% for row in content.itertuples() %}
                <p class="debug">building {{ row.prefLabel }}</p>
                {{ concept_macros.build_concept_view(graph, row.member, row.prefLabel, level) }}
            {% endfor %}
        {% endif %}
    {% endcall %}
{% endmacro %}
