{% import "common/macros.html" as mc %}
{% import "common/collection_macros.html" as cv %}

<h1>Lam proprieties collections</h1>
{#  this will start from the a top collection and will get all narrower collections recursively  #}
{% macro build_child_collections(collection_uri, level) %}
    {%- set next_lvl = level + 1 %}
    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX dct: <http://purl.org/dc/terms/>
PREFIX dc: <http://purl.org/dc/elements/1.1/>

select ?member ?prefLabel

{
  values ?collection {<"~collection_uri~">}
?member a skos:Collection .
  ?collection skos:member ?member .
  optional{
  ?member skos:prefLabel ?prefLabel
}

}" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% call mc.render_fetch_results(content, error) %}
        {% if not content.empty %}
            {% for idx, row in content.iterrows() %}
                {{ cv.build_collection_view(row["member"], row["prefLabel"], level) }}
                {{ build_child_collections(row["member"], next_lvl) }}
            {% endfor %}
        {% endif %}
    {% endcall %}
{% endmacro %}

{#       starting from top collections this will build all collections         #}

{% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX euvoc: <http://publications.europa.eu/ontology/euvoc#>

select ?collection ?prefLabel {
  ?collection a skos:Collection .
  optional{

  ?collection skos:prefLabel ?prefLabel
  }
  ?collection euvoc:order ?order .
  FILTER NOT EXISTS {
  ?parent skos:member ?collection
  }
} ORDER by ?order" %}
{% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
{% call mc.render_fetch_results(content, error) %}

    {% set level = 2 %}
    {% for idx, row in content.iterrows() %}
        {{ cv.build_collection_view(row["collection"], row["prefLabel"], level) }}
        {% set collection_uri = row["collection"] %}
        {{ build_child_collections(collection_uri,level=3) }}
    {% endfor %}
{% endcall %}




