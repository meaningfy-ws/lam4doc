{% import "common/macros.html" as macros %}

{% macro build_instance_view (parameters, instance_uri, instance_label, level, is_concept=false) %}
    {% if conf.debug %}
        <p class="debug">build_instance_view <strong>{{ instance_label }} level:{{ level }}</strong></p>
    {% endif %}
    <h{{ level }} id="{{ instance_uri }}">
        {{ instance_label }}
        {% if is_concept %}
            <sup title="concept">[cn]</sup>
        {% else %}
            <sup title="collection">[cl]</sup>
        {% endif %}
    </h{{ level }}>
    <section>
        {{ build_instance_metadata_part(parameters, instance_uri) }}
        {{ build_instance_editorial_part(parameters, instance_uri) }}
        {{ build_lam_property_configuration_list(parameters, instance_uri) }}
        {{ build_lam_classification_hint_list(parameters, instance_uri) }}
        {{ build_constraints(parameters, instance_uri) }}
        {{ build_useful_links(parameters, instance_uri) }}
    </section>
{% endmacro %}


{% macro build_constraints(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_constraints <strong>{{ instance_uri }}</strong></p>
    {% endif %}
    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
    prefix lam: <http://publications.europa.eu/ontology/lam-skos-ap#>
    prefix lamd: <http://publications.europa.eu/resources/authority/lam/>

    select distinct ?constraintValue ?graphUri
    {
      values ?instanceUri {<"~instance_uri~">}
      graph ?graphUri
      {
        ?instancePath lam:path ?instanceUri .
        ?instancePath sh:value ?constraintValue .
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query, parameters).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            {{ macros.render_description_item_plain_literal (content, "constraintValue", "Encountered value constraints", True) }}
        {% endif %}
    {% endcall %}
{% endmacro %}


{% macro build_instance_metadata_part(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_instance_metadata_part <strong>{{ instance_uri }}</strong></p>
    {% endif %}
    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
    PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX dct: <http://purl.org/dc/terms/>
    PREFIX euvoc: <http://publications.europa.eu/ontology/euvoc#>
    PREFIX owl: <http://www.w3.org/2002/07/owl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    SELECT ?deprecated ?altLabel ?created ?modified ?notation ?identifier ?order ?class ?path
    FROM <~graph>
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance owl:deprecated ?deprecated
      }
      union {
        ?instance skos:altLabel ?altLabel
      }
      union {
        ?instance dct:created ?created .
      }
      union {
        ?instance dct:modified ?modified
      }
      union {
        ?instance skos:notation ?notation
      }
      union {
        ?instance dct:identifier ?identifier
      }
      union {
        ?instance euvoc:order ?order .
      }
      union {
        ?instance sh:class ?class .
      }
      union {
        ?instance sh:path ?path .
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query, parameters).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            <dl>
                <dt>IRI</dt>
                <dd><p class="iri_monospace">{{ instance_uri }}</p></dd>
            </dl>
            {{ macros.render_description_item_plain_literal (content, "deprecated", "Deprecated on") }}
            {{ macros.render_description_item_plain_literal (content, "altLabel", "Alternative label") }}
            {{ macros.render_description_item_plain_literal (content, "created", "Created on") }}
            {{ macros.render_description_item_plain_literal (content, "modified", "Modified on") }}
            {{ macros.render_description_item_plain_literal (content, "notation", "Notation") }}
            {{ macros.render_description_item_plain_literal (content, "identifier", "Identifier") }}
            {{ macros.render_description_item_plain_literal (content, "order", "Order") }}
            {% if conf.debug %}
                <p class="debug-render">skos concept part for</p>
            {% endif %}
            {{ macros.render_description_item_iri (content, "class", "Class", external_link=True) }}
            {{ macros.render_description_item_iri (content, "path", "Path", external_link=True) }}
        {% endif %}
    {% endcall %}
{% endmacro %}

{% macro build_instance_editorial_part(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_instance_editorial_part <strong>{{ instance_uri }}</strong></p>
    {% endif %}
    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
    PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX dct: <http://purl.org/dc/terms/>
    PREFIX euvoc: <http://publications.europa.eu/ontology/euvoc#>

    select ?definition ?scopeNote ?example ?changeNote ?historyNote ?editorialNote ?note ?member ?broaderConcept ?shName ?shDescription
    FROM <~graph>
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance skos:definition ?definition .
      }
      union {
        ?instance skos:scopeNote ?scopeNote
      }
      union {
        ?instance skos:example ?example
      }
      union {
        ?instance skos:changeNote ?changeNote
      }
      union {
        ?instance skos:historyNote ?historyNote
      }
      union {
        ?instance skos:editorialNote ?editorialNote
      }
      union {
        ?instance skos:note ?note
      }
      union {
        ?instance skos:member ?member .
      }
      union {
        ?broaderConcept skos:broader ?instance .
      }
      union {
        ?instance sh:name ?shName .
      }
      union {
        ?instance sh:description ?shDescription .
      }
    }" %}

    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query, parameters).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna(how="all").empty %}
            {% if conf.debug %}
                <p class="debug-render">skos editorial part for <strong>{{ instance_uri }}</strong></p>
            {% endif %}
            {{ macros.render_description_item_plain_literal (content,"definition", "Definition", True, accordion_content_state="show") }}
            {{ macros.render_description_item_plain_literal (content, "scopeNote", "Scope note", True, accordion_content_state="show") }}
            {{ macros.render_description_item_plain_literal (content, "example", "Example", True, True) }}
            {{ macros.render_description_item_plain_literal (content, "changeNote", "Change note", True) }}
            {{ macros.render_description_item_plain_literal (content, "historyNote", "History note", True) }}
            {{ macros.render_description_item_plain_literal (content, "editorialNote", "Editorial note", True) }}
            {{ macros.render_description_item_plain_literal (content, "note", "Note" , True) }}
            {{ macros.render_description_item_iri (content, "member", "Members", None,True) }}
            {{ macros.render_description_item_iri (content, "broaderConcept", "Broader Concepts", None,True) }}
            {% if conf.debug %}
                <p class="debug-render">sh editorial part for <strong>{{ instance_uri }}</strong></p>
            {% endif %}
            {{ macros.render_description_item_plain_literal (content, "shName", "Name") }}
            {{ macros.render_description_item_plain_literal (content, "shDescription", "Description", True) }}
        {% endif %}
    {% endcall %}
{% endmacro %}


{% macro build_lam_property_configuration_list(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_lam_property_configuration_list <strong>{{ instance_uri }}</strong></p>
    {% endif %}
    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    select ?propertyConfiguration
    FROM <~graph>
    {
      values ?instance {<"~instance_uri~">}
      ?instance lam:hasPropertyConfiguration ?propertyConfiguration .
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query, parameters).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.empty %}
            <div class="card">
                <div class="card-header">
                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                    <a class="text-dark font-weight-bold" onclick="showContent()">
                        Property configurations
                    </a>
                </div>
                <div class="collapse">
                    <div class="card-body">
                        {% for row in content.itertuples() %}
                            {{ build_lam_classification_hint_or_property_configuration(parameters, row.propertyConfiguration) }}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    {% endcall %}
{% endmacro %}


{% macro build_lam_classification_hint_list(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_lam_property_configuration_list <strong>{{ instance_uri }}</strong></p>
    {% endif %}
    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    select ?classificationHint
    FROM <~graph>
    {
      values ?instance {<"~instance_uri~">}
      ?instance lam:classifyWith ?classificationHint .
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query, parameters).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.empty %}
            <div class="card">
                <div class="card-header">
                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                    <a class="text-dark font-weight-bold" onclick="showContent()">
                        Defining configurations
                    </a>
                </div>
                <div class="collapse">
                    <div class="card-body">
                        {% for row in content.itertuples() %}
                            {{ build_lam_classification_hint_or_property_configuration(parameters, row.classificationHint) }}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    {% endcall %}
{% endmacro %}


{% macro build_lam_classification_hint_or_property_configuration(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_lam_classification_hint <strong>{{ instance_uri }}</strong></p>
    {% endif %}
    {% set select_query =
    "PREFIX sh: <http://www.w3.org/ns/shacl#>
    PREFIX lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    select ?name ?path ?flags ?pattern ?class ?value ?minCount ?maxCount ?configurations
    FROM <~graph>
    {
      values ?instance {<"~instance_uri~">}
      {
        ?instance sh:name ?name .
      }
      union {
        ?instance lam:path ?path .
      }
      union {
        ?instance sh:flags ?flags
      }
      union {
        ?instance sh:pattern ?pattern
      }
      union {
        ?instance sh:class ?class
      }
      union {
        ?instance sh:value ?value
      }
      union {
        ?instance sh:minCount ?minCount
      }
      union {
        ?instance sh:maxCount ?maxCount
      }
      union {
        ?instance lam:hasAnnotationConfiguration ?configurations
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query, parameters).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {{ render_lam_classification_hint_or_property_configuration(content.dropna(how="all")) }}

        {% set values = content["configurations"].dropna() %}
        {% if not values.empty %}
            {% if conf.debug %}
                <p class="debug">build_lam_property_configuration for hasAnnotationConfiguration
                    <strong>{{ instance_uri }}</strong></p>
            {% endif %}
            {% for idx, item in values.iteritems() %}
                <em>{{ build_lam_classification_hint_or_property_configuration(parameters, item) }}</em>
            {% endfor %}
        {% endif %}
    {% endcall %}
{% endmacro %}


{% macro render_lam_classification_hint_or_property_configuration(content) %}
    {% if conf.debug %}
        <p class="debug-render">render_lam_classification_hint</p>
    {% endif %}
    {% if not content.empty %}
        {% set _ = replace_strings_in_tabular(content, target_columns=['path'], value_mapping_dict=inverted_prefixes) %}

        {{ macros.render_inline_link(content, 'path', 'property') }}
        {{ macros.render_inline_values(content, 'minCount', 'min', '0') }}
        {{ macros.render_inline_values(content, 'maxCount', 'max', '*') }}
        {{ macros.render_inline_values(content, "flags", "flags") }}
        {{ macros.render_inline_values(content, "pattern", "pattern") }}
        {{ macros.render_inline_values(content, "class", "class") }}
        {{ macros.render_inline_link(content, "value", "value", True) }}
        <br>
    {% endif %}
{% endmacro %}


{% macro build_useful_links(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_useful_links <strong>{{ instance_uri }}</strong></p>
    {% endif %}
    {#    {% set graph = parameters.graph %}#}

    {{ build_links_from_classify_with_or_has_property_configuration(parameters, instance_uri) }}
{% endmacro %}

{% macro build_links_from_classify_with_or_has_property_configuration(parameters, instance_uri) %}
    {% if conf.debug %}
        <p class="debug">build_used_in_classify_with_or_has_property_configuration <strong>{{ instance_uri }}</strong>
        </p>
    {% endif %}
    {% set select_query =
    "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
    prefix lam: <http://publications.europa.eu/ontology/lam-skos-ap#>

    select distinct ?link ?linkLabel ?graphUri
    {
      values ?instanceUri {<"~instance_uri~">}
      graph ?graphUri
      {
        ?propConfig lam:path ?instanceUri .
        optional {
          ?link lam:classifyWith | lam:hasPropertyConfiguration ?propConfig.
          optional {
            ?link skos:prefLabel ?linkLabel .
          }
        }
      }
    }" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query, parameters).fetch_tabular() %}
    {% call macros.render_fetch_results(content, error) %}
        {% if not content.dropna().empty %}
            <div class="card">
                <div class="card-header">
                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                    <a class="text-dark font-weight-bold" onclick="showContent()">
                        Useful links
                    </a>
                </div>
                <div class="collapse">
                    <div class="card-body">
                        {% for row in content.itertuples() %}
                            <a href="#{{ row.link }}">{{ row.linkLabel }}</a><br>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    {% endcall %}
{% endmacro %}
